<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Equipo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Sistema de Créditos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.index') }}">Panel</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('payments.planes') }}">Planes</a>
                    </li>
                    {% if active_plan %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('upgrade.index') }}">
                            <i class="bi bi-arrow-up-circle"></i> Actualizar Plan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('payments.recargar_creditos') }}">Recargar Créditos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('team.index') }}">Equipo</a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">Cerrar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row mb-4">
            <div class="col-md-12">
                <h1 class="display-4">Gestión de Equipo</h1>
                <p class="lead">Administra los miembros de tu equipo</p>
            </div>
        </div>
        
        <!-- NUEVO BLOQUE: Mostrar enlace de la última invitación -->
        {% if session.get('last_invite_url') %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-success">
                    <h5><i class="bi bi-link-45deg"></i> Enlace de invitación para {{ session.get('last_invite_email') }}</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="lastInviteUrlInput" value="{{ session.get('last_invite_url') }}" readonly>
                        <button class="btn btn-outline-primary" type="button" onclick="copyLastInviteUrl()">
                            <i class="bi bi-clipboard"></i> Copiar
                        </button>
                    </div>
                    <small class="text-muted">Comparte este enlace con el usuario invitado. El enlace estará activo por 7 días.</small>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- FIN DEL NUEVO BLOQUE -->
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Información del Plan</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Plan actual:</strong> {{ active_plan.plan_name }}</p>
                        <p><strong>Usuarios:</strong> {{ current_users }} de {{ max_users }} utilizados</p>
                        
                        {% if current_users >= max_users %}
                        <div class="alert alert-warning">
                            Has alcanzado el límite de usuarios para tu plan actual.
                            <a href="{{ url_for('payments.planes') }}" class="btn btn-sm btn-outline-primary">Actualizar Plan</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de estadísticas básicas -->
        {% if team_usage_stats %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Estadísticas de Uso del Equipo</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Créditos Usados</th>
                                        <th>Última Actividad</th>
                                        <th>% del Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in team_usage_stats %}
                                    <tr>
                                        <td>{{ stat.email }}</td>
                                        <td>{{ stat.used_credits }}</td>
                                        <td>
                                            {% if stat.last_activity %}
                                                {% if stat.last_activity.strftime %}
                                                    {{ stat.last_activity.strftime('%d/%m/%Y %H:%M') }}
                                                {% else %}
                                                    {{ stat.last_activity }}
                                                {% endif %}
                                            {% else %}
                                                Sin actividad
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ stat.percentage|default(0) }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Miembros del Equipo</h5>
                        {% if can_invite %}
                        <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#inviteModal">
                            Invitar Miembro
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if team_members %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for member in team_members %}
                                    <tr>
                                        <td>{{ member.email }}</td>
                                        <td>
                                            {% if member.role == 'admin' %}
                                            <span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                title="Acceso total, puede gestionar miembros y ajustes financieros">
                                                Administrador
                                            </span>
                                            {% elif member.role == 'manager' %}
                                            <span class="badge bg-warning" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                title="Puede gestionar miembros pero no ajustes financieros">
                                                Manager
                                            </span>
                                            {% elif member.role == 'editor' %}
                                            <span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                title="Puede editar contenido y usar todas las funciones">
                                                Editor
                                            </span>
                                            {% else %}
                                            <span class="badge bg-info" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                title="Solo puede ver contenido, sin capacidad de edición">
                                                Visualizador
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if member.status == 'pending' %}
                                            <span class="badge bg-warning">Pendiente</span>
                                            {% elif member.status == 'active' %}
                                            <span class="badge bg-success">Activo</span>
                                            {% else %}
                                            <span class="badge bg-secondary">{{ member.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if member.joined_at %}
                                                {% if member.joined_at.strftime %}
                                                    {{ member.joined_at.strftime('%d/%m/%Y') }}
                                                {% else %}
                                                    {{ member.joined_at }}
                                                {% endif %}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                    Acciones
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <button type="button" class="dropdown-item" data-bs-toggle="modal" 
                                                            data-bs-target="#changeRoleModal" 
                                                            data-member-id="{{ member.member_id }}"
                                                            data-member-email="{{ member.email }}"
                                                            data-member-role="{{ member.role }}">
                                                            Cambiar Rol
                                                        </button>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form method="post" action="{{ url_for('team.remove_member') }}">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                            <input type="hidden" name="member_id" value="{{ member.member_id }}">
                                                            <button type="submit" class="dropdown-item text-danger" 
                                                                onclick="return confirm('¿Estás seguro de eliminar a este miembro?')">
                                                                Eliminar Miembro
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-center">No has agregado ningún miembro a tu equipo todavía.</p>
                        {% if can_invite %}
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">Invitar a tu primer miembro</button>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        {% if pending_invitations and pending_invitations|length > 0 %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Enlaces de Invitación Generados</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Fecha</th>
                                        <th>Expira</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invitation in pending_invitations %}
                                    <tr>
                                        <td>{{ invitation.email }}</td>
                                        <td>
                                            {% if invitation.role == 'admin' %}
                                            <span class="badge bg-danger">Administrador</span>
                                            {% elif invitation.role == 'manager' %}
                                            <span class="badge bg-warning">Manager</span>
                                            {% elif invitation.role == 'editor' %}
                                            <span class="badge bg-success">Editor</span>
                                            {% else %}
                                            <span class="badge bg-info">Visualizador</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if invitation.created_at %}
                                                {% if invitation.created_at.strftime %}
                                                    {{ invitation.created_at.strftime('%d/%m/%Y') }}
                                                {% else %}
                                                    {{ invitation.created_at }}
                                                {% endif %}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if invitation.expires_at %}
                                                {% if invitation.expires_at.strftime %}
                                                    {{ invitation.expires_at.strftime('%d/%m/%Y') }}
                                                {% else %}
                                                    {{ invitation.expires_at }}
                                                {% endif %}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary copy-link" 
                                                    data-token="{{ invitation.token }}"
                                                    data-bs-toggle="tooltip" 
                                                    data-bs-placement="top" 
                                                    title="Copiar enlace de invitación">
                                                    <i class="bi bi-clipboard"></i> Copiar Enlace
                                                </button>
                                                <form method="post" action="{{ url_for('team.cancel_invitation') }}" class="ms-1">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <input type="hidden" name="invitation_id" value="{{ invitation.invitation_id }}">
                                                    <button type="submit" class="btn btn-sm btn-secondary" 
                                                        onclick="return confirm('¿Estás seguro de revocar este enlace de invitación?')">
                                                        Revocar Enlace
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Modal para invitar miembros -->
    <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inviteModalLabel">Invitar Miembro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{{ url_for('team.invite_member') }}">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="role" class="form-label">Rol</label>
                            <select class="form-select" id="role" name="role">
                                <option value="viewer">Visualizador (solo lectura)</option>
                                <option value="editor">Editor (puede editar contenido)</option>
                                <option value="manager">Manager (gestión de miembros)</option>
                                <option value="admin">Administrador (acceso completo)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Permisos del rol seleccionado:</label>
                            <div class="role-permissions viewer-permissions">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Usar servicios básicos</li>
                                    <li class="list-group-item text-muted">Sin acceso a edición</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión de miembros</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión financiera</li>
                                </ul>
                            </div>
                            <div class="role-permissions editor-permissions d-none">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Editar contenido</li>
                                    <li class="list-group-item">Usar todos los servicios</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión de miembros</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión financiera</li>
                                </ul>
                            </div>
                            <div class="role-permissions manager-permissions d-none">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Editar contenido</li>
                                    <li class="list-group-item">Usar todos los servicios</li>
                                    <li class="list-group-item">Gestionar miembros del equipo</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión financiera</li>
                                </ul>
                            </div>
                            <div class="role-permissions admin-permissions d-none">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Editar contenido</li>
                                    <li class="list-group-item">Usar todos los servicios</li>
                                    <li class="list-group-item">Gestionar miembros del equipo</li>
                                    <li class="list-group-item">Acceso a gestión financiera</li>
                                </ul>
                            </div>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Generar Enlace de Invitación</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal para cambiar rol -->
    <div class="modal fade" id="changeRoleModal" tabindex="-1" aria-labelledby="changeRoleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeRoleModalLabel">Cambiar Rol de Miembro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{{ url_for('team.change_role') }}">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="member_id" id="change_role_member_id">
                        
                        <p>Cambiar rol para: <strong id="change_role_email"></strong></p>
                        
                        <div class="mb-3">
                            <label for="new_role" class="form-label">Nuevo Rol</label>
                            <select class="form-select" id="new_role" name="new_role">
                                <option value="viewer">Visualizador (solo lectura)</option>
                                <option value="editor">Editor (puede editar contenido)</option>
                                <option value="manager">Manager (gestión de miembros)</option>
                                <option value="admin">Administrador (acceso completo)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Permisos del rol seleccionado:</label>
                            <div class="role-permissions viewer-permissions-change">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Usar servicios básicos</li>
                                    <li class="list-group-item text-muted">Sin acceso a edición</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión de miembros</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión financiera</li>
                                </ul>
                            </div>
                            <div class="role-permissions editor-permissions-change d-none">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Editar contenido</li>
                                    <li class="list-group-item">Usar todos los servicios</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión de miembros</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión financiera</li>
                                </ul>
                            </div>
                            <div class="role-permissions manager-permissions-change d-none">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Editar contenido</li>
                                    <li class="list-group-item">Usar todos los servicios</li>
                                    <li class="list-group-item">Gestionar miembros del equipo</li>
                                    <li class="list-group-item text-muted">Sin acceso a gestión financiera</li>
                                </ul>
                            </div>
                            <div class="role-permissions admin-permissions-change d-none">
                                <ul class="list-group">
                                    <li class="list-group-item">Ver contenido</li>
                                    <li class="list-group-item">Editar contenido</li>
                                    <li class="list-group-item">Usar todos los servicios</li>
                                    <li class="list-group-item">Gestionar miembros del equipo</li>
                                    <li class="list-group-item">Acceso a gestión financiera</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Inicializar tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Manejar cambio de rol en modal de invitación
        const roleSelect = document.getElementById('role');
        if (roleSelect) {
            roleSelect.addEventListener('change', function() {
                // Ocultar todos los paneles de permisos
                document.querySelectorAll('.role-permissions').forEach(function(el) {
                    el.classList.add('d-none');
                });
                
                // Mostrar el panel correspondiente al rol seleccionado
                const selectedRole = this.value;
                document.querySelector('.' + selectedRole + '-permissions').classList.remove('d-none');
            });
        }
        
        // Manejar cambio de rol en modal de cambio de rol
        const newRoleSelect = document.getElementById('new_role');
        if (newRoleSelect) {
            newRoleSelect.addEventListener('change', function() {
                // Ocultar todos los paneles de permisos
                document.querySelectorAll('.role-permissions').forEach(function(el) {
                    if (el.classList.contains('viewer-permissions-change') ||
                        el.classList.contains('editor-permissions-change') ||
                        el.classList.contains('manager-permissions-change') ||
                        el.classList.contains('admin-permissions-change')) {
                        el.classList.add('d-none');
                    }
                });
                
                // Mostrar el panel correspondiente al rol seleccionado
                const selectedRole = this.value;
                document.querySelector('.' + selectedRole + '-permissions-change').classList.remove('d-none');
            });
        }
        
        // Manejar el modal de cambio de rol
        const changeRoleModal = document.getElementById('changeRoleModal');
        if (changeRoleModal) {
            changeRoleModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const memberId = button.getAttribute('data-member-id');
                const memberEmail = button.getAttribute('data-member-email');
                const memberRole = button.getAttribute('data-member-role');
                
                document.getElementById('change_role_member_id').value = memberId;
                document.getElementById('change_role_email').textContent = memberEmail;
                
                // Seleccionar el rol actual
                const roleSelect = document.getElementById('new_role');
                if (roleSelect) {
                    for (let i = 0; i < roleSelect.options.length; i++) {
                        if (roleSelect.options[i].value === memberRole) {
                            roleSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // Disparar el evento change para actualizar la visualización de permisos
                    const event = new Event('change');
                    roleSelect.dispatchEvent(event);
                }
            });
        }
        
        // Funcionalidad para copiar enlaces de invitación
        const copyButtons = document.querySelectorAll('.copy-link');
        copyButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const token = this.getAttribute('data-token');
                // CAMBIO: usamos 'unirse' en lugar de 'registro'
                const inviteUrl = window.location.origin + '/unirse?token=' + token;
                
                navigator.clipboard.writeText(inviteUrl).then(function() {
                    // Cambiar texto temporalmente para indicar que se copió
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check-lg"></i> Copiado!';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-outline-primary');
                    
                    setTimeout(function() {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-primary');
                    }, 2000);
                }).catch(function(err) {
                    console.error('No se pudo copiar el texto: ', err);
                    alert('No se pudo copiar el enlace. Por favor, inténtalo manualmente.');
                });
            });
        });

        // Para copiar el último enlace de invitación
        window.copyLastInviteUrl = function() {
            const copyText = document.getElementById("lastInviteUrlInput");
            copyText.select();
            document.execCommand("copy");
            
            // Feedback visual
            const copyButton = copyText.nextElementSibling;
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="bi bi-check-lg"></i> Copiado!';
            copyButton.classList.add('btn-success');
            copyButton.classList.remove('btn-outline-primary');
            
            setTimeout(function() {
                copyButton.innerHTML = originalText;
                copyButton.classList.remove('btn-success');
                copyButton.classList.add('btn-outline-primary');
            }, 2000);
        };
    });
    </script>
</body>
</html>